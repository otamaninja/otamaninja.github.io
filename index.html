<html>
  <head>
    <title>Sound Slider</title>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
  </head>
  <body>
    <script>
      class SoundController {
        constructor() {
          this.context = null; // AudioContext は初期化しない
          this.snd = null;
          this.gainNode = null;
          this.selectableWaveformTypes = ["sine", "square", "sawtooth", "triangle"];
          this.waveformType = "sine";
          this.baseFrequency = 100;
          this.frequencyStep = 100;
          this.createUI();
          this.createFrequencyDisplay();
        }

        initAudioContext() {
          if (!this.context) {
            this.context = new (window.AudioContext || window.webkitAudioContext)();
          }

          // iOS の "suspended" 状態を解除する
          if (this.context.state === "suspended") {
            this.context.resume().then(() => console.log("AudioContext resumed"));
          }
        }

        playSin(freq) {
          this.initAudioContext(); // 初回タッチで AudioContext を作成

          if (this.snd) return;

          this.snd = this.context.createOscillator();
          this.snd.type = this.waveformType;
          this.snd.frequency.value = freq;

          this.gainNode = this.context.createGain();
          this.gainNode.gain.setValueAtTime(0, this.context.currentTime); // 初期音量を 0 にする
          this.gainNode.gain.linearRampToValueAtTime(1, this.context.currentTime + 0.01); // 徐々に音を上げる
          this.gainNode.connect(this.context.destination);

          this.snd.connect(this.gainNode);
          this.snd.start();
        }

        stopSin() {
          if (this.snd) {
            this.gainNode.gain.setValueAtTime(1, this.context.currentTime);
            this.gainNode.gain.linearRampToValueAtTime(0, this.context.currentTime + 0.3);
            setTimeout(() => {
              this.snd.stop();
              this.snd = null;
            }, 300);
          }
        }

        createUI() {
          const soundSlider = document.createElement("div");
          soundSlider.style.position = "fixed";
          soundSlider.style.right = "0";
          soundSlider.style.top = "0";
          soundSlider.style.width = "3.5em";
          soundSlider.style.height = "100vh";
          soundSlider.style.background = "#333";

          soundSlider.addEventListener("touchstart", (e) => {
            const y = e.touches[0].pageY;
            this.playSin(this.baseFrequency + y);
            this.updateFrequencyDisplay(
              e.touches[0].pageX,
              e.touches[0].pageY,
              this.baseFrequency + y
            );
          });

          soundSlider.addEventListener("touchmove", (e) => {
            const y = e.touches[0].pageY;
            if (this.snd) {
              this.snd.frequency.value = this.baseFrequency + y;
              this.updateFrequencyDisplay(
                e.touches[0].pageX,
                e.touches[0].pageY,
                this.baseFrequency + y
              );
            }
          });

          soundSlider.addEventListener("touchend", () => {
            this.stopSin();
            this.freqDisplay.style.visibility = "hidden";
          });

          document.body.append(soundSlider);
        }

        createFrequencyDisplay() {
          this.freqDisplay = document.createElement("div");
          this.freqDisplay.style.position = "absolute";
          this.freqDisplay.style.left = "1em";
          this.freqDisplay.style.top = "1em";
          this.freqDisplay.style.color = "#FFF";
          this.freqDisplay.style.backgroundColor = "rgba(0, 0, 0, 0.7)";
          this.freqDisplay.style.padding = "0.5em";
          this.freqDisplay.style.borderRadius = "0.5em";
          this.freqDisplay.style.visibility = "hidden";
          document.body.append(this.freqDisplay);
        }

        updateFrequencyDisplay(x, y, freq) {
          this.freqDisplay.innerText = `Freq: ${freq.toFixed(0)} Hz`;
          this.freqDisplay.style.visibility = "visible";
        }
      }

      new SoundController();
    </script>
  </body>
</html>
