<!DOCTYPE html>
<html>

  <head>
    <title>Sound Slider</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  </head>

  <body>
    <script>
      class SoundController {
          constructor() {
              this.context = new AudioContext();
              this.snds = [];
              this.gainNode = null;
              this.waveformType = "sine";
              this.baseFrequency = 153;
              this.sliderPosition = "Left"; // 初期位置を左に設定
              this.createUI();
              this.createFrequencyDisplay();
          }

          createUI() {
              document.body.style.overflow = "hidden";

              this.soundSlider = document.createElement('div');
              this.soundSlider.style.width = "3.5em";
              this.soundSlider.style.height = "100vh";
              this.soundSlider.style.background = "#333";
              this.soundSlider.style.position = "fixed"; // 絶対位置指定

              document.body.append(this.soundSlider);
              this.updateSliderPosition(); // ここでスライダーの位置を適用

              this.soundSlider.addEventListener("touchstart", (e) => {
                  const y = e.touches[0].pageY;
                  const height = window.innerHeight || document.documentElement.clientHeight; // 修正
                  const freq = Math.max(130, Math.min(1050, this.baseFrequency + (y / height * (1050 - 130))));
                  this.playSin(freq);
                  this.updateFrequencyDisplay(e.touches[0].pageX, e.touches[0].pageY, freq, height);
              });
              this.soundSlider.addEventListener("touchmove", (e) => {
                  const y = e.touches[0].pageY;
                  const height = window.innerHeight || document.documentElement.clientHeight;
                  if (this.snd) {
                      const freq = Math.max(130, Math.min(1050, this.baseFrequency + (y / height * (1050 - 130))));
                      this.snd.frequency.value = freq;
                      this.updateFrequencyDisplay(e.touches[0].pageX, e.touches[0].pageY, freq, height);
                  }
              });

              this.soundSlider.addEventListener("touchend", () => {
                  this.stopSin();
                  this.freqDisplay.style.visibility = "hidden";
              });

              const positionButton = document.createElement('button');
              positionButton.innerText = "Toggle Left/Right";
              positionButton.style.position = "fixed";
              positionButton.style.bottom = "10px";
              positionButton.style.right = "10px";
              positionButton.style.padding = "10px 20px";
              positionButton.style.fontSize = "1.2em";
              positionButton.style.backgroundColor = "#007BFF";
              positionButton.style.color = "#FFF";
              positionButton.style.border = "none";
              positionButton.style.borderRadius = "5px";
              positionButton.style.cursor = "pointer";
              positionButton.addEventListener("click", () => {
                  this.sliderPosition = this.sliderPosition === "Left" ? "Right" : "Left";
                  this.updateSliderPosition();
              });

              document.body.append(positionButton);
          }

          updateSliderPosition() {
              if (this.sliderPosition === "Left") {
                  this.soundSlider.style.left = "2em";
                  this.soundSlider.style.right = "";
              } else {
                  this.soundSlider.style.right = "2em";
                  this.soundSlider.style.left = "";
              }
          }

          createFrequencyDisplay() {
              this.freqDisplay = document.createElement('div');
              this.freqDisplay.style.position = "absolute";
              this.freqDisplay.style.color = "#FFF";
              this.freqDisplay.style.fontSize = "1.5em";
              this.freqDisplay.style.backgroundColor = "rgba(0, 0, 0, 0.5)";
              this.freqDisplay.style.padding = "0.5em";
              this.freqDisplay.style.borderRadius = "0.5em";
              this.freqDisplay.style.visibility = "hidden";
              document.body.appendChild(this.freqDisplay);
          }

          playSin(freq) {
              if (this.snd) return;
              this.snd = this.context.createOscillator();
              this.snd.type = this.waveformType;
              this.snd.frequency.value = freq;

              this.gainNode = this.context.createGain();
              this.gainNode.gain.setValueAtTime(1, this.context.currentTime);
              this.gainNode.connect(this.context.destination);

              this.snd.connect(this.gainNode);
              this.snd.start();
          }

          stopSin() {
              if (this.snd && this.context) {
                  this.gainNode.gain.setValueAtTime(1, this.context.currentTime);
                  this.gainNode.gain.linearRampToValueAtTime(0, this.context.currentTime + 0.3);
                  const removedSnd = this.snd;
                  this.snd = null;
                  setTimeout(() => {
                      removedSnd.stop();
                      removedSnd.disconnect();
                  }, 300);
              }
          }
          /*
            updateFrequencyDisplay(x, y, freq) {
            this.freqDisplay.style.left = `6rem`;
            this.freqDisplay.style.top = `${y}px`;
            this.freqDisplay.innerText = `Freq: ${freq.toFixed(0)} Hz, x: ${x], y: ${y}`;
            this.freqDisplay.style.visibility = "visible";
            }
            }
          */
          updateFrequencyDisplay(x, y, freq, height) {
              this.freqDisplay.style.left = `6rem`;
              this.freqDisplay.style.top = `${y}px`;
              this.freqDisplay.innerText = `Freq: ${freq.toFixed(0)} Hz, x: ${x}, y: ${y}, height: ${height}`;
              this.freqDisplay.style.visibility = "visible";
          }
      }
      document.body.style.background = "#CCC";
      const soundController = new SoundController();
    </script>
  </body>

</html>
