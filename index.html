<!DOCTYPE html>
<html>

  <head>
    <title>Sound Slider</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
      .soundSlider {
          width: 3.5em;
          height: 100vh;
          background: #333;
          position: fixed;
      }
      .soundSlider::before, .soundSlider::after {
          content: "";
          position: absolute;
          left: 0;
          width: 100%;
          height: 2px;
          background: white;
      }
      .soundSlider::before {
          top: 4%;
      }
      .soundSlider::after {
          bottom: 15%;
      }
    </style>
  </head>

  <body>
    <script>
      class SoundController {
          constructor() {
              this.context = new AudioContext();
              this.snds = [];
              this.gainNode = null;
              this.waveformType = "sine";
              this.freqMidHigh = 1046.50; // C5
              this.freqMidLow = 130.81; // C3
              this.frequencyRange = {LOW: "LOW", MID: "MID", HIGH: "HIGH"};
              this.currentRange = "MID";              
              this.sliderPosition = "Left"; // 初期位置を左に設定
              this.createUI();
              this.createFrequencyDisplay();
          }

          createUI() {
              document.body.style.overflow = "hidden";

              this.soundSlider = document.createElement('div');
              this.soundSlider.classList.add('soundSlider');
              document.body.append(this.soundSlider);

              this.positionButton = document.createElement('button');
              this.positionButton.innerText = "Toggle";
              this.positionButton.style.position = "fixed";
              this.positionButton.style.bottom = "10px";
              this.positionButton.style.right = "2em";
              this.positionButton.style.left = "";
              this.positionButton.style.padding = "10px 20px";
              this.positionButton.style.fontSize = "1.2em";
              this.positionButton.style.backgroundColor = "#007BFF";
              this.positionButton.style.color = "#FFF";
              this.positionButton.style.border = "none";
              this.positionButton.style.borderRadius = "5px";
              this.positionButton.style.cursor = "pointer";
              this.positionButton.addEventListener("click", () => {
                  this.sliderPosition = this.sliderPosition === "Left" ? "Right" : "Left";
                  this.updateSliderPosition();
              });

              document.body.append(this.positionButton);

              this.frequencySelector = document.createElement('div');
              this.frequencySelector.style.position = "fixed";
              this.frequencySelector.style.bottom = "60px";
              this.frequencySelector.style.right = "2em";
              this.frequencySelector.style.backgroundColor = "rgba(255, 255, 255, 0.8)";
              this.frequencySelector.style.padding = "10px";
              this.frequencySelector.style.borderRadius = "5px";

              ["LOW", "MID", "HIGH"].forEach(level => {
                  const label = document.createElement('label');
                  const radio = document.createElement('input');
                  radio.type = "radio";
                  radio.name = "frequency";
                  radio.value = level;
                  radio.checked = this.currentRange === level;
                  radio.addEventListener("change", () => {
                      this.currentRange = level;
                      switch(this.currentRange){
	              case "LOW": // 
			  this.freqMidHigh = 261.63; // C4
			  this.freqMidLow = 32.70; // C1
	                  break;
	              case "HIGH":
			  this.freqMidHigh = 4186.01; // C8
			  this.freqMidLow = 523.25; // C5
	                  break;
	              default:
			  this.freqMidHigh = 1046.50; // C6
			  this.freqMidLow = 130.81; // C3
	 	          break;                      	
                      }
                  });

                  label.appendChild(radio);
                  label.appendChild(document.createTextNode(level));
                  this.frequencySelector.appendChild(label);
                  this.frequencySelector.appendChild(document.createElement('br'));
              });

              document.body.append(this.frequencySelector);


              this.updateSliderPosition(); // ここでスライダーの位置を適用

              this.soundSlider.addEventListener("touchstart", (e) => {
                  const y = e.touches[0].pageY;
                  const height = window.innerHeight || document.documentElement.clientHeight; // 修正
                  //const freq = Math.max(this.freqMidLow, Math.min(this.freqMidHigh, this.freqMidLow + (y / height * (this.freqMidHigh - this.freqMidLow))));
                  const freq = Math.max(this.freqMidLow, Math.min(this.freqMidHigh, this.freqMidLow + ((y / height - 0.06) * (this.freqMidHigh - this.freqMidLow) / 0.80)));
                  this.playSin(freq);
                  this.updateFrequencyDisplay(e.touches[0].pageX, e.touches[0].pageY, freq, height);
              });
              this.soundSlider.addEventListener("touchmove", (e) => {
                  const y = e.touches[0].pageY;
                  const height = window.innerHeight || document.documentElement.clientHeight;
                  if (this.snd) {
                      const freq = Math.max(this.freqMidLow, Math.min(this.freqMidHigh, this.freqMidLow + ((y / height - 0.06) * (this.freqMidHigh - this.freqMidLow) / 0.80)));
                      this.snd.frequency.value = freq;
                      this.updateFrequencyDisplay(e.touches[0].pageX, e.touches[0].pageY, freq, height);
                  }
              });

              this.soundSlider.addEventListener("touchend", () => {
                  this.stopSin();
                  this.freqDisplay.style.visibility = "hidden";
              });
          }

          updateSliderPosition() {
              if (this.sliderPosition === "Left") {
                  this.soundSlider.style.left = "2em";
                  this.soundSlider.style.right = "";
                  this.positionButton.style.right = "2em";
                  this.positionButton.style.left = "";
                  this.frequencySelector.style.right = "2em";
                  this.frequencySelector.style.left = "";
              } else {
                  this.soundSlider.style.right = "2em";
                  this.soundSlider.style.left = "";
                  this.positionButton.style.right = "";
                  this.positionButton.style.left = "2em";
                  this.frequencySelector.style.left = "2em";
                  this.frequencySelector.style.right = "";
              }
          }

          createFrequencyDisplay() {
              this.freqDisplay = document.createElement('div');
              this.freqDisplay.style.position = "absolute";
              this.freqDisplay.style.color = "#FFF";
              this.freqDisplay.style.fontSize = "1.5em";
              this.freqDisplay.style.backgroundColor = "rgba(0, 0, 0, 0.5)";
              this.freqDisplay.style.padding = "0.5em";
              this.freqDisplay.style.borderRadius = "0.5em";
              this.freqDisplay.style.visibility = "hidden";
              document.body.appendChild(this.freqDisplay);
          }

          playSin(freq) {
              if (this.snd) return;
              this.snd = this.context.createOscillator();
              this.snd.type = this.waveformType;
              this.snd.frequency.value = freq;

              this.gainNode = this.context.createGain();
              this.gainNode.gain.setValueAtTime(1, this.context.currentTime);
              this.gainNode.connect(this.context.destination);

              this.snd.connect(this.gainNode);
              this.snd.start();
          }

          stopSin() {
              if (this.snd && this.context) {
                  this.gainNode.gain.setValueAtTime(1, this.context.currentTime);
                  this.gainNode.gain.linearRampToValueAtTime(0, this.context.currentTime + 0.3);
                  const removedSnd = this.snd;
                  this.snd = null;
                  setTimeout(() => {
                      removedSnd.stop();
                      removedSnd.disconnect();
                  }, 300);
              }
          }
          /*
            updateFrequencyDisplay(x, y, freq) {
            this.freqDisplay.style.left = `6rem`;
            this.freqDisplay.style.top = `${y}px`;
            this.freqDisplay.innerText = `Freq: ${freq.toFixed(0)} Hz, x: ${x], y: ${y}`;
            this.freqDisplay.style.visibility = "visible";
            }
            }
          */
          updateFrequencyDisplay(x, y, freq, height) {
              this.freqDisplay.style.left = `6rem`;
              this.freqDisplay.style.top = `(${y} - 10)px`;
              this.freqDisplay.innerText = `Freq: ${freq.toFixed(0)} Hz, x: ${x}, y: ${y}, height: ${height}`;
              this.freqDisplay.style.visibility = "visible";
          }
      }
      document.body.style.background = "#CCC";
      const soundController = new SoundController();
    </script>
  </body>

</html>
